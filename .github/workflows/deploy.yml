name: Deploy Database to All Clients
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual deploy'
jobs:
  build-and-deploy:
    runs-on: [self-hosted, windows, sql-deploy]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Database Project (.dacpac)
        shell: pwsh
        run: |
          $msbuildPath = "C:\Program Files\Microsoft Visual Studio\18\Community\MSBuild\Current\Bin\amd64\MSBuild.exe"
          $projectPath = "Database Project\Database Project.sqlproj"
          & $msbuildPath "$projectPath" /p:Configuration=Release /p:Platform="Any CPU"
          if ($LASTEXITCODE -ne 0) {
            Write-Error "MSBuild failed with exit code $LASTEXITCODE"
            exit 1
          }

      - name: Deploy to All Clients
        shell: pwsh
        env:
          DEPLOY_SQL_USER:      ${{ secrets.DEPLOY_SQL_USER }}
          DEPLOY_SQL_PASSWORD:  ${{ secrets.DEPLOY_SQL_PASSWORD }}
          REGISTRY_SERVER:      ${{ secrets.REGISTRY_SERVER }}
          REGISTRY_DATABASE:    ${{ secrets.REGISTRY_DATABASE }}
        run: |
          .\.github\scripts\Deploy-AllClients.ps1 `
            -DacpacPath       "Database Project\bin\Release\Database Project.dacpac" `
            -RegistryServer   $env:REGISTRY_SERVER `
            -RegistryDatabase $env:REGISTRY_DATABASE `
            -SqlUser          $env:DEPLOY_SQL_USER `
            -SqlPassword      $env:DEPLOY_SQL_PASSWORD

      - name: Upload deployment log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-log-${{ github.run_number }}
          path: "${{ github.workspace }}\\*.log"