name: Deploy Database to All Clients
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual deploy'
      version:
        description: 'Release version to deploy (e.g., v1.2.0)'
        required: false
        default: ''

jobs:
  build-and-deploy:
    runs-on: [self-hosted, windows, sql-deploy]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Database Project (.dacpac)
        shell: pwsh
        run: |
          $msbuildPath = "C:\Program Files\Microsoft Visual Studio\18\Community\MSBuild\Current\Bin\amd64\MSBuild.exe"
          $projectPath = "Database Project\Database Project.sqlproj"
          & $msbuildPath "$projectPath" /p:Configuration=Release /p:Platform="Any CPU"
          if ($LASTEXITCODE -ne 0) {
            Write-Error "MSBuild failed with exit code $LASTEXITCODE"
            exit 1
          }

      - name: Deploy to All Clients
        shell: pwsh
        env:
          DEPLOY_SQL_USER:      ${{ secrets.DEPLOY_SQL_USER }}
          DEPLOY_SQL_PASSWORD:  ${{ secrets.DEPLOY_SQL_PASSWORD }}
          REGISTRY_SERVER:      ${{ secrets.REGISTRY_SERVER }}
          REGISTRY_DATABASE:    ${{ secrets.REGISTRY_DATABASE }}
        run: |
          .\.github\scripts\Deploy-AllClients.ps1 `
            -DacpacPath       "Database Project\bin\Output\Database Project.dacpac" `
            -RegistryServer   $env:REGISTRY_SERVER `
            -RegistryDatabase $env:REGISTRY_DATABASE `
            -SqlUser          $env:DEPLOY_SQL_USER `
            -SqlPassword      $env:DEPLOY_SQL_PASSWORD `
            -VersionNumber    "${{ github.event.inputs.version || github.run_number }}"

      - name: Save deployment log locally
        if: always()
        shell: pwsh
        run: |
          $logDir = "D:\Database Deployment\Database Project\DeploymentLogs"
          if (!(Test-Path $logDir)) { New-Item -ItemType Directory -Path $logDir -Force }
          $logs = Get-ChildItem -Path $logDir -Filter "*.log"
          if ($logs.Count -gt 0) {
            Write-Host "Logs saved to $logDir"
            $logs | ForEach-Object { Write-Host "  - $($_.Name)" }
          } else {
            Write-Host "No log files found in $logDir"
          }